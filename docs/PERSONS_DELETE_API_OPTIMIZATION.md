# Persons åˆ é™¤æ¥å£ä¼˜åŒ–è¯´æ˜

## ğŸ“Œ ä¼˜åŒ–æ¦‚è¿°

é’ˆå¯¹ `/persons` åˆ é™¤ç›¸å…³æ¥å£å­˜åœ¨çš„é—®é¢˜è¿›è¡Œäº†ä»¥ä¸‹ä¼˜åŒ–ï¼š

1. âœ… ä¿®å¤ `delete_persons_by_name_api` çš„åŒåè¯¯åˆ é£é™©
2. âœ… ä¼˜åŒ– `delete_person_api` ç§»é™¤è·¯å¾„å ä½ç¬¦ï¼Œæ”¹ç”¨è¯·æ±‚ä½“
3. âœ… ç»Ÿä¸€ä½¿ç”¨å…¨å±€ `db` å®ä¾‹ï¼Œç§»é™¤ä¸å¿…è¦çš„ä¾èµ–æ³¨å…¥

---

## ğŸ”§ å…·ä½“ä¼˜åŒ–å†…å®¹

### **ä¼˜åŒ– 1ï¼š`DELETE /persons/by_name` - æ·»åŠ åŒåè­¦å‘Š**

#### **é—®é¢˜åˆ†æ**

**åŸå®ç°**:
```python
@router.delete("/by_name")
async def delete_persons_by_name_api(
    name: str = Query(..., min_length=1),
    db: AsyncIOMotorClient = Depends(get_session)
):
    """æŒ‰å§“ååˆ é™¤äººç‰©æ¥å£ï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰"""
    deleted_count = await person_crud.delete_persons_by_name(db, name_keyword=name)
```

**å­˜åœ¨çš„é£é™©**:
- âŒ ä½¿ç”¨ MongoDB æ­£åˆ™æ¨¡ç³ŠåŒ¹é… `{"name": {"$regex": name, "$options": "i"}}`
- âŒ åˆ é™¤ "å¼ ä¸‰" ä¼šåŒæ—¶åˆ é™¤ï¼š
  - "å¼ ä¸‰"
  - "å¼ ä¸‰ä¸°"
  - "å°å¼ ä¸‰"
  - "å¼ ä¸‰çš„æœ‹å‹"
  - ä»»ä½•åŒ…å« "å¼ ä¸‰" çš„å§“å
- âŒ æ— äºŒæ¬¡ç¡®è®¤ï¼Œé«˜é£é™©æ“ä½œ
- âŒ ä»…è¿”å›åˆ é™¤æ•°é‡ï¼Œç”¨æˆ·æ— æ³•çŸ¥é“åˆ é™¤äº†å“ªäº›äºº

#### **ä¼˜åŒ–æ–¹æ¡ˆ**

**æ–°å®ç°**:
```python
@router.delete("/by_name")
async def delete_persons_by_name_api(
    name: str = Query(..., min_length=1)
):
    """
    æŒ‰å§“ååˆ é™¤äººç‰©æ¥å£ï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰
    - âš ï¸ è­¦å‘Šï¼šæ­¤æ¥å£ä½¿ç”¨æ¨¡ç³ŠåŒ¹é…ï¼Œå¯èƒ½è¯¯åˆ åŒåäººç‰©
    - âš ï¸ ä¾‹å¦‚ï¼šåˆ é™¤"å¼ ä¸‰"å¯èƒ½åŒæ—¶åˆ é™¤"å¼ ä¸‰ä¸°"ç­‰åŒ…å«è¯¥å…³é”®å­—çš„äººç‰©
    - å»ºè®®ï¼šä½¿ç”¨ /delete æ¥å£ï¼ˆæ”¯æŒç²¾ç¡®åŒ¹é…ï¼‰æˆ– /by_id æ¥å£ï¼ˆIDå”¯ä¸€ï¼‰
    - ä¿ç•™æ¥å£ï¼Œç”¨äºå‘åå…¼å®¹
    """
    deleted_count = await person_crud.delete_persons_by_name(db, name_keyword=name)
    # ... å…¶ä½™é€»è¾‘ä¸å˜
```

**ä¼˜åŒ–ç‚¹**:
- âœ… åœ¨æ–‡æ¡£å­—ç¬¦ä¸²ä¸­æ·»åŠ æ˜¾è‘—è­¦å‘Š
- âœ… æç¤ºç”¨æˆ·ä½¿ç”¨æ›´å®‰å…¨çš„æ›¿ä»£æ¥å£
- âœ… ç§»é™¤ `Depends(get_session)`ï¼Œç»Ÿä¸€ä½¿ç”¨å…¨å±€ `db`

**å»ºè®®ä½¿ç”¨åœºæ™¯**:
- æ‰¹é‡æ¸…ç†æµ‹è¯•æ•°æ®
- å¼€å‘ç¯å¢ƒå¿«é€Ÿåˆ é™¤

**ä¸å»ºè®®ä½¿ç”¨åœºæ™¯**:
- ç”Ÿäº§ç¯å¢ƒåˆ é™¤ç‰¹å®šäººç‰©ï¼ˆå®¹æ˜“è¯¯åˆ ï¼‰
- ç²¾ç¡®åˆ é™¤æ“ä½œï¼ˆåº”ä½¿ç”¨ `/by_id`ï¼‰

---

### **ä¼˜åŒ– 2ï¼š`DELETE /persons/by_id` - ç§»é™¤è·¯å¾„å ä½ç¬¦**

#### **é—®é¢˜åˆ†æ**

**åŸå®ç°**:
```python
@router.delete("/{person_id}")
async def delete_person_api(person_id: str, db=Depends(get_session)):
    """æŒ‰IDåˆ é™¤äººç‰©æ¥å£"""
    info = await person_crud.delete_person(db, person_id=person_id)
```

**å­˜åœ¨çš„é—®é¢˜**:
- âŒ ä½¿ç”¨è·¯å¾„å‚æ•° `/{person_id}` å®¹æ˜“ä¸å…¶ä»–è·¯ç”±å†²çª
  - ä¾‹å¦‚ï¼š`DELETE /persons/batch` å’Œ `DELETE /persons/{person_id}` å¯èƒ½å†²çª
  - FastAPI è·¯ç”±åŒ¹é…é¡ºåºå¯èƒ½å¯¼è‡´ "batch" è¢«å½“ä½œ person_id
- âŒ RESTful é£æ ¼ä¸é¡¹ç›®å…¶ä»–æ¥å£ä¸ä¸€è‡´ï¼ˆå…¶ä»–æ¥å£ç”¨è¯·æ±‚ä½“ï¼‰
- âŒ ä½¿ç”¨ `Depends(get_session)` ä½†é¡¹ç›®ä¸­å·²æœ‰å…¨å±€ `db`

#### **ä¼˜åŒ–æ–¹æ¡ˆ**

**æ–°å®ç°**:
```python
@router.delete("/by_id")
async def delete_person_by_id_api(
    request: DeletePersonByIdRequest = Body(..., description="æŒ‰IDåˆ é™¤äººç‰©è¯·æ±‚ä½“")
):
    """
    æŒ‰IDåˆ é™¤äººç‰©æ¥å£
    - ç²¾ç¡®åŒ¹é…äººç‰©ID
    - IDæ˜¯å”¯ä¸€æ ‡è¯†ï¼Œä¸ä¼šå‡ºç°è¯¯åˆ 
    """
    info = await person_crud.delete_person(db, person_id=request.id)
    # ... å…¶ä½™é€»è¾‘ä¸å˜
```

**æ–°å¢è¯·æ±‚æ¨¡å‹**:
```python
class DeletePersonByIdRequest(BaseModel):
    """
    æŒ‰IDåˆ é™¤äººç‰©è¯·æ±‚æ¨¡å‹
    - IDæ˜¯å”¯ä¸€æ ‡è¯†ï¼Œä¸ä¼šå‡ºç°è¯¯åˆ 
    """
    id: str
```

**ä¼˜åŒ–ç‚¹**:
- âœ… è·¯ç”±æ”¹ä¸º `/persons/by_id`ï¼Œé¿å…è·¯å¾„å†²çª
- âœ… ä½¿ç”¨è¯·æ±‚ä½“ä¼ å‚ï¼Œä¸é¡¹ç›®é£æ ¼ä¸€è‡´
- âœ… ç§»é™¤ `Depends(get_session)`ï¼Œä½¿ç”¨å…¨å±€ `db`
- âœ… ID å”¯ä¸€æ€§ä¿è¯ä¸ä¼šè¯¯åˆ 

---

### **ä¼˜åŒ– 3ï¼šç»Ÿä¸€ä½¿ç”¨å…¨å±€ `db` å®ä¾‹**

#### **é—®é¢˜åˆ†æ**

**ä»£ç ä¸ä¸€è‡´**:
```python
from app.core.database import db          # ç¬¬ 10 è¡Œï¼šå¯¼å…¥å…¨å±€ db
from app.core.database import get_session  # ç¬¬ 11 è¡Œï¼šå¯¼å…¥ä¾èµ–æ³¨å…¥å‡½æ•°

# éƒ¨åˆ†æ¥å£ä½¿ç”¨å…¨å±€ db
async def create_person_api(...):
    doc, is_updated = await person_crud.update_or_create_person(db, person_dict)  # âœ…

# éƒ¨åˆ†æ¥å£ä½¿ç”¨ä¾èµ–æ³¨å…¥
async def delete_person_api(person_id: str, db=Depends(get_session)):  # âŒ
```

**å­˜åœ¨çš„é—®é¢˜**:
- âŒ åŒä¸€æ–‡ä»¶ä¸­ä¸¤ç§æ–¹å¼æ··ç”¨ï¼Œä»£ç é£æ ¼ä¸ç»Ÿä¸€
- âŒ å¢åŠ ç»´æŠ¤æˆæœ¬
- âŒ ä¾èµ–æ³¨å…¥åœ¨æ­¤åœºæ™¯ä¸‹æ²¡æœ‰å®é™…å¿…è¦ï¼ˆå…¨å±€è¿æ¥æ± å·²è¶³å¤Ÿï¼‰

#### **ä¼˜åŒ–æ–¹æ¡ˆ**

**ç»Ÿä¸€ä½¿ç”¨å…¨å±€ `db`**:
```python
# æ‰€æœ‰æ¥å£ç»Ÿä¸€ä½¿ç”¨å…¨å±€ db
async def delete_persons_by_name_api(name: str = Query(...)):
    deleted_count = await person_crud.delete_persons_by_name(db, name_keyword=name)

async def delete_person_by_id_api(request: DeletePersonByIdRequest = Body(...)):
    info = await person_crud.delete_person(db, person_id=request.id)
```

**ä¼˜åŒ–ç‚¹**:
- âœ… ä»£ç é£æ ¼ç»Ÿä¸€
- âœ… å‡å°‘ä¸å¿…è¦çš„ä¾èµ–æ³¨å…¥
- âœ… ç®€åŒ–ä»£ç é€»è¾‘

---

## ğŸ“Š æ¥å£å¯¹æ¯”æ€»ç»“

| æ¥å£ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | è¯´æ˜ |
|------|--------|--------|------|
| **DELETE /persons/by_name** | æ¨¡ç³ŠåŒ¹é…ï¼Œæ— è­¦å‘Š | æ·»åŠ è­¦å‘Šæ–‡æ¡£ï¼Œç§»é™¤ `Depends` | ä¿ç•™å‘ä¸‹å…¼å®¹ï¼Œä½†ä¸æ¨è |
| **DELETE /persons/{person_id}** | è·¯å¾„å‚æ•°ï¼Œ`Depends(get_session)` | æ”¹ä¸º `/by_id` + è¯·æ±‚ä½“ + å…¨å±€ `db` | é¿å…è·¯ç”±å†²çªï¼Œé£æ ¼ç»Ÿä¸€ |
| **æ•°æ®åº“ä¾èµ–** | æ··ç”¨å…¨å±€ `db` å’Œ `Depends` | ç»Ÿä¸€ä½¿ç”¨å…¨å±€ `db` | ä»£ç é£æ ¼ä¸€è‡´ |

---

## ğŸ¯ æ¨èçš„åˆ é™¤æ¥å£ä½¿ç”¨æŒ‡å—

### **åœºæ™¯ 1ï¼šç²¾ç¡®åˆ é™¤å•ä¸ªäººç‰©ï¼ˆæ¨èï¼‰**

**ä½¿ç”¨æ¥å£**: `DELETE /persons/by_id`

**è¯·æ±‚ç¤ºä¾‹**:
```json
{
  "id": "507f1f77bcf86cd799439011"
}
```

**ç‰¹ç‚¹**:
- âœ… ID å”¯ä¸€ï¼Œç»å¯¹ä¸ä¼šè¯¯åˆ 
- âœ… æœ€å®‰å…¨çš„åˆ é™¤æ–¹å¼

---

### **åœºæ™¯ 2ï¼šæŒ‰æ¡ä»¶åˆ é™¤ï¼ˆæ¨èï¼‰**

**ä½¿ç”¨æ¥å£**: `DELETE /persons/delete`

**è¯·æ±‚ç¤ºä¾‹**:
```json
{
  "name": "å¼ ä¸‰",
  "id": null
}
```
æˆ–
```json
{
  "name": null,
  "id": "507f1f77bcf86cd799439011"
}
```

**ç‰¹ç‚¹**:
- âœ… çµæ´»æ€§é«˜ï¼Œæ”¯æŒå¤šç§åˆ é™¤æ¡ä»¶
- âœ… æ¨¡ç³ŠåŒ¹é… nameï¼Œä½†ä¼šè¿”å›åˆ é™¤æ•°é‡

---

### **åœºæ™¯ 3ï¼šæ‰¹é‡æ¨¡ç³Šåˆ é™¤ï¼ˆä¸æ¨èï¼‰**

**ä½¿ç”¨æ¥å£**: `DELETE /persons/by_name?name=å¼ ä¸‰`

**ç‰¹ç‚¹**:
- âš ï¸ æ¨¡ç³ŠåŒ¹é…ï¼Œå¯èƒ½è¯¯åˆ 
- âš ï¸ ä»…ç”¨äºå¼€å‘ç¯å¢ƒæˆ–æ‰¹é‡æ¸…ç†
- âš ï¸ ç”Ÿäº§ç¯å¢ƒæ…ç”¨

---

## ğŸ”„ è¿ç§»å»ºè®®

### **å‰ç«¯ä»£ç è¿ç§»**

**åŸä»£ç **:
```javascript
// åˆ é™¤äººç‰©ï¼ˆè·¯å¾„å‚æ•°ï¼‰
await fetch(`/persons/${personId}`, { method: 'DELETE' });
```

**æ–°ä»£ç **:
```javascript
// æ¨èï¼šä½¿ç”¨ /by_id æ¥å£
await fetch('/persons/by_id', {
  method: 'DELETE',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ id: personId })
});
```

---

## ğŸ›¡ï¸ å®‰å…¨å»ºè®®

1. **ç”Ÿäº§ç¯å¢ƒ**:
   - âœ… ä»…ä½¿ç”¨ `DELETE /persons/by_id` æˆ– `DELETE /persons/delete`ï¼ˆå¸¦ IDï¼‰
   - âŒ ç¦ç”¨ `DELETE /persons/by_name`ï¼ˆæ·»åŠ æƒé™æ§åˆ¶ï¼‰

2. **å¼€å‘ç¯å¢ƒ**:
   - âœ… å¯ä½¿ç”¨ `DELETE /persons/by_name` å¿«é€Ÿæ¸…ç†æµ‹è¯•æ•°æ®
   - âš ï¸ ä½†éœ€æ˜ç¡®çŸ¥é“ä¼šåˆ é™¤å“ªäº›æ•°æ®

3. **æœ€ä½³å®è·µ**:
   - åˆ é™¤å‰å…ˆæŸ¥è¯¢ç¡®è®¤ï¼ˆä½¿ç”¨ `GET /persons/search`ï¼‰
   - é‡è¦æ“ä½œæ·»åŠ äºŒæ¬¡ç¡®è®¤æœºåˆ¶
   - è®°å½•åˆ é™¤æ—¥å¿—ï¼ˆå·²åœ¨ä»£ç ä¸­å®ç°ï¼‰

---

## ğŸ“ æ›´æ–°æ—¥å¿—

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ |
|------|------|---------|
| v2.0 | 2026-01-07 | ä¼˜åŒ–åˆ é™¤æ¥å£ï¼Œæ·»åŠ å®‰å…¨è­¦å‘Šï¼Œç»Ÿä¸€ db ä½¿ç”¨ |
| v1.0 | - | åˆå§‹ç‰ˆæœ¬ |

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰ç–‘é—®ï¼Œè¯·å‚è€ƒï¼š
- [RECOGNIZE_API_ERRORS.md](./RECOGNIZE_API_ERRORS.md) - `/recognize` æ¥å£é”™è¯¯ç è¯´æ˜
- åç«¯æ—¥å¿—ä¸­çš„ `[/persons/*]` ç›¸å…³æ—¥å¿—
